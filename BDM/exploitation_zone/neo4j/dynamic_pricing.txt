MATCH (p:Product)-[r:in_stock]-(s:Shipment)
WITH p.intermediateComId as communityId, p.id as id,  duration.inDays(date({year: 2009, month: 6, day: 1}),date(s.expiry_date) ).days as daysToExpire, r.selling_price as currentPrice , r.quantity as quantityLeft
WITH communityId, CASE 
 WHEN daysToExpire < 1110 and quantityLeft > 10 THEN currentPrice/2
 WHEN daysToExpire < 1110 and quantityLeft < 10 THEN (currentPrice/5)*4
 WHEN daysToExpire < 1120 and daysToExpire > 1110 and quantityLeft > 10 THEN (currentPrice/5)*4
 WHEN daysToExpire < 1120 and daysToExpire > 1110 and quantityLeft < 10 THEN (currentPrice/10)*9
 WHEN daysToExpire < 1130 and daysToExpire > 1120 and quantityLeft > 10 THEN (currentPrice/10)*9
 ELSE 'NaN' END AS newPrice, daysToExpire, currentPrice, quantityLeft, id
 WHERE newPrice <> 'NaN'
RETURN communityId,collect([id,newPrice,daysToExpire, currentPrice, quantityLeft]) as offerRecommendations
